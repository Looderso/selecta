# Database Migrations Documentation

## Overview

This directory contains the database migration scripts for Selecta's schema evolution. Migrations are managed using Alembic, which provides a way to incrementally update the database schema while preserving existing data.

## Migration Architecture

Selecta uses a simplified migration system where:

1. The initial schema is created by SQLAlchemy's `create_all()`
2. Subsequent changes are managed through Alembic migration scripts
3. Each migration has unique revision identifiers for version tracking

## Migration Files

### Core Files

- `env.py`: Alembic environment configuration, connects migrations to SQLAlchemy models
- `__init__.py`: Package initialization

### Version Scripts

- `001_initial_schema.py`: Initial database schema creation (baseline)
- `002_platform_metadata_update.py`: Updates to platform metadata structure
- `003_add_image_model.py`: Addition of the Image model for artwork management
- `004_add_track_quality.py`: Addition of track quality rating fields

## Migration Process

### Creating Migrations

Migrations are created using the Alembic command-line tool:

```bash
# Manual creation
alembic revision -m "description_of_changes"

# Autogenerated based on model changes
alembic revision --autogenerate -m "description_of_changes"
```

### Running Migrations

Migrations are typically run automatically during application startup, but can be manually executed:

```bash
# Upgrade to latest version
alembic upgrade head

# Upgrade to specific version
alembic upgrade 003

# Downgrade to previous version
alembic downgrade -1

# Downgrade to specific version
alembic downgrade 002
```

## Migration Guidelines

### Writing Migrations

1. **Backwards Compatibility**: Always include both `upgrade()` and `downgrade()` functions
2. **Data Preservation**: Handle existing data appropriately when changing schema
3. **Atomic Changes**: Each migration should represent a single, coherent change
4. **Testing**: Test migrations on sample data before deploying

### Migration Operations

Common operations in migrations:

- Creating/dropping tables: `op.create_table()`, `op.drop_table()`
- Adding/removing columns: `op.add_column()`, `op.drop_column()`
- Creating/dropping indexes: `op.create_index()`, `op.drop_index()`
- Creating/dropping constraints: `op.create_foreign_key()`, `op.drop_constraint()`
- Data migration: Use SQLAlchemy within transaction context

## Implementation Notes

- The initial schema (001) is handled by SQLAlchemy's `create_all()` method
- Later migrations use Alembic operations to modify the schema
- SQLite has limited support for certain schema changes (like column drops)
- Some complex migrations may require table recreation for SQLite compatibility

## Best Practices

- Always backup your database before running migrations
- Test migrations on development environments before production
- Include data migration code when schema changes affect existing data
- Document complex migrations with comments
- Keep migrations small and focused for easier rollbacks
